<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Soundboard</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  </head>
  <body>
    <app>
      <div class='container'>
        <div id='current'>
          <h1>{{ current.key }}</h1>
          <audio controls autoplay>
            <source>
          </audio>
        </div>
        <!-- {{#sounds}} -->
        <div class='row'>
          <div class='col-md-12'>
            <div class='sound'>
              <span class='pull-right'>
                <a href='https://1cymxr59n5.execute-api.us-east-1.amazonaws.com/prod/soundboard/{{ key }}' play-pi target='_blank' class='btn btn-default btn-no-border btn-xs'>
                  <i class='glyphicon glyphicon-cloud'> </i>
                  <span class='hidden-xs'> send to pi</span>
                </a>
              </span>
              <a href='?key={{ key }}' play-here='{{ mediaUrl }}' title='{{ key }}' class='btn btn-block btn-xs text-align-left'>
                <i class='glyphicon glyphicon-play'> </i>
                <span>{{ key }}</span>
              </a>
              <!--<a href='{{ mediaUrl }}' target='_blank' class='btn btn-link btn-xs text-muted'>download</a>-->
            </div>
          </div>
        </div>
        <!-- {{/sounds}} -->
      </div>
    </app>
    <style>
      .btn-link-
      .btn-no-border { border: 0; }
      .text-align-left { text-align: left; }
      .text-align-right { text-align: right; }
      .sound  {
        border-top: 1px solid #eee;
          padding: 8px 0;
      }

      app {
        display: block;
        margin-bottom: 40px;
      }
    </style>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.1/mustache.min.js'></script>
    <script>
      var soundboardMediaUrl = "http://soundboard.alexjpaz.com.s3-website-us-east-1.amazonaws.com/";

      var root = document.querySelector('app');

      var ajax = function(method, url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, url, true);
        xhr.onload = function() {
          callback(JSON.parse(this.responseText));
        };
        xhr.send();
      };

      var view = {
        sounds: [],
        soundsMap: {}
      };

      speechSynthesis.onvoiceschanged = function() {
        var msg = new SpeechSynthesisUtterance();
        msg.voice = this.getVoices().filter(v => v.name == 'Cellos')[0];
        msg.text = name;
      };

      var speak =  function speak(text, callback) {
        var msg = new SpeechSynthesisUtterance();
        var voices = speechSynthesis.getVoices();
        msg.voice = voices[0];
        msg.voiceURI = 'native';
        msg.volume = 1;
        msg.rate = 1;
        msg.pitch = 0;
        msg.text = text;
        msg.lang = 'en-US';
        msg.onend = callback;

        speechSynthesis.speak(msg);
      }

      var bindAll = function(selector, event, handler) {
        var nodes = document.querySelectorAll(selector);
        var arr = Array.prototype.slice.call(nodes);

        arr.forEach(function(node) {
          node.addEventListener(event, function(e) {
            handler.call(node, e);
          }, true);
        });
      };

      window.andHisNameIs = function(name) {
        var startAudio = new Audio(soundboardMediaUrl+"chop/john_cena/start");
        var endAudio = new Audio(soundboardMediaUrl+"chop/john_cena/end");


        startAudio.load();
        endAudio.load();

        startAudio.play();
        startAudio.addEventListener("ended", function() {
          speak(name, function() {
            endAudio.play();
          });
        }, false);
      };

      var play = function(mediaUrl) {
        //var audio = new Audio(mediaUrl);
        //audio.play();
        var audio = document.querySelector('#current audio');
        var audioSource = document.querySelector('#current audio source');
        audioSource.setAttribute('src', mediaUrl);
        audio.load();
        audio.play();
      };

      var getParameterByName = function getParameterByName(name, url) {
          if (!url) url = window.location.href;
          name = name.replace(/[\[\]]/g, "\\$&");
          var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
              results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      var render = function(root, view) {
        var output = Mustache.render(root.innerHTML, view);
        root.innerHTML = output;

        bindAll('[play-pi]', 'click', function(e) {
          var self = this;
          e.stopPropagation();
          e.preventDefault();

          self.querySelector('i').classList[1] = 'glyphicon-option-horizontal';

          var href = self.getAttribute('href');
          var script = document.createElement('script');
          script.src = href;
          script.onload = function() {
            console.log('1');
          };
          document.body.appendChild(script);
        });

        bindAll('[play-here]', 'click', function(e) {
          var self = this;
          e.stopPropagation();
          e.preventDefault();

          var mediaUrl = self.getAttribute('play-here');
          var key = self.getAttribute('title');

          var currentTitle = document.querySelector('#current h1');
          currentTitle.innerHTML = key;
          history.pushState(null, null, '?key='+key);
          play(mediaUrl);
        });


        play(view.current.mediaUrl);
      };

      ajax('GET', soundboardMediaUrl + 'index.json', function(data) {

        data.forEach(function(soundKey) {
          var sound = {
            key: soundKey,
            mediaUrl: soundboardMediaUrl + soundKey
          };

          view.sounds.push(sound);

          view.soundsMap[soundKey] = sound;
        });

        var currentKey = getParameterByName('key');
        console.log(currentKey);


        var name = getParameterByName('name');

        if(name) {
          andHisNameIs(decodeURIComponent(name));
        }

        view.current = view.soundsMap[currentKey];

        render(root, view);
      });
    </script>
  </body>
</html>
